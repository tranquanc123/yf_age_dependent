for(study_row in 1:nrow(sel_sero_data)){
age_range = sel_sero_data$AGE_LOWER[study_row]:sel_sero_data$AGE_UPPER[study_row] + 1
cov_v = sel_sero_data[study_row, ind.cov][age_range] %>% sapply(function(x) x*VE) %>% t
pop_v = sel_sero_data[study_row, ind.pop][age_range] %>% as.vector() %>% unlist
FOI_sero_cumsum = sapply(gamma, function(x) (age_range)*x)
seropos = 1-exp(-FOI_sero_cumsum)
sus_v = pop_v * (cov_v + (1-cov_v) * seropos)
p = colSums(sus_v)/sum(pop_v)
p[p > 1 - 1e-16] = 1 - 1e-16
p[p < 1e-16] = 1e-16
p_m[study_row,] = p
}
p_m_sum = apply(p_m, 1, quantile95cri)
sero_data_fit = cbind(data_subset, model_type, study, data_type, sel_sero_data[,1:8], data.frame(t(p_m_sum)))
sero_data_fit_l = c(sero_data_fit_l, list(sero_data_fit))
#WAIC:
LL_samples = sapply(1:n_samples, function(x) dbinom(sel_sero_data$POSITIVE, sel_sero_data$SAMPLE_SIZE, p_m[,x], log = T))
lppd <- sapply(1:nrow(sel_sero_data), function(i) logSumExp(LL_samples[i,]) - log(n_samples)) %>% sum
pWAIC <- sapply(1:nrow(sel_sero_data) , function(i) var(LL_samples[i,])) %>% sum
WAIC = -2*(lppd - pWAIC)
WAIC_l = c(WAIC_l, WAIC)
} else if(data_type == "case"){
sel_case_data = filter(case.noti.df, study_id == study)
gamma = par_sel[,1];
rho = inverse_logit(par_sel[,2]);
VE = par_sel[,3]
FOI_case_id_row = max(sel_case_data$year) - sel_case_data$year + sel_case_data$age + 1
FOI_case_int_v = sapply(gamma, function(x) (FOI_case_id_row - 1) * x) %>% t
pop_m = matrix(sel_case_data$pop, nrow = n_samples, ncol = nrow(sel_case_data))
cov_m = matrix(sel_case_data$cov, nrow = n_samples, ncol = nrow(sel_case_data))
exp_cases = exp(-FOI_case_int_v) * (1 - exp(-gamma)) * rho * pop_m * (1 - cov_m*VE)
exp_case_by_age_group = aggregate(t(exp_cases), by = list(sel_case_data$age_group_ID), sum)[,-1]
exp_case_by_age_group[exp_case_by_age_group < 1e-3] = 1e-3
exp_case_by_age_group_sum = apply(exp_case_by_age_group, 1, quantile95cri)
case_by_study_agegroup_i = aggregate(sel_case_data$case, by = list(sel_case_data$age_group_ID), unique)$x
case_data_fit = data.frame(data_subset, model_type, study, data_type,
age_l = aggregate(sel_case_data$age, by = list(sel_case_data$age_group_ID), min)$x,
age_u = aggregate(sel_case_data$age, by = list(sel_case_data$age_group_ID), max)$x,
t(exp_case_by_age_group_sum), case = case_by_study_agegroup_i)
case_data_fit_l = c(case_data_fit_l, list(case_data_fit))
#WAIC:
LL_samples = sapply(1:n_samples, function(x) dpois(case_by_study_agegroup_i, exp_case_by_age_group[,x], log = T))
lppd_v <- sapply(1:nrow(exp_case_by_age_group), function(i) logSumExp(LL_samples[i,]) - log(n_samples))
pWAIC_v <- sapply(1:nrow(exp_case_by_age_group) , function(i) var(LL_samples[i,]))
WAIC_v = -2*(lppd_v - pWAIC_v)
WAIC_v_l = c(WAIC_v_l, WAIC_v)
WAIC_l = c(WAIC_l, sum(WAIC_v))
}
}
library(matrixStats)
par_sum_l = c()
par_dist_l = c()
sero_data_fit_l = c()
case_data_fit_l = c()
WAIC_v_l = c()
WAIC_l = c()
#Read output:
for(which.scenario in 1:N_study){
study = all_scen$study_id[which.scenario]
data_type = all_scen$data_type[which.scenario]
print(study)
output = readRDS(paste0("../output/MCMC_output/MCMC_output_1e4_noage_", data_type, "_", study, "_init_rstan.Rdata"))
#summary parameters:
par_sum = summary(output)$summary[-which(rownames(summary(output)$summary) == "lp__"),c("2.5%", "50%", "97.5%", "Rhat")] %>% data.frame()
par_sum$Study_id = study
par_sum$data_type = data_type
par_sum_l = c(par_sum_l, list(par_sum))
#par extract
par_sel = extract(output, pars = "lp__", include = FALSE) %>% Reduce(cbind, .)
par_dist_l = c(par_dist_l, list(par_sel))
n_samples = nrow(par_sel)
#data fit and WAIC:
if(data_type == "sero"){
sel_sero_data = filter(sero_data, STUDY_ID == study)
if(study %in% c("ETH-10-2014-TSEGAYE", "NGA-8-2008-BABA")){
sel_0_cov_study = which(sel_sero_data$STUDY_ID %in% c("ETH-10-2014-TSEGAYE", "NGA-8-2008-BABA")) #no coverage for Baba and Tsegaye
sel_sero_data[sel_0_cov_study,ind.cov] = 0
}
gamma = par_sel[,1];
VE = par_sel[,2]
p_m  = matrix(nrow = nrow(sel_sero_data), ncol = nrow(par_sel))
for(study_row in 1:nrow(sel_sero_data)){
age_range = sel_sero_data$AGE_LOWER[study_row]:sel_sero_data$AGE_UPPER[study_row] + 1
cov_v = sel_sero_data[study_row, ind.cov][age_range] %>% sapply(function(x) x*VE) %>% t
pop_v = sel_sero_data[study_row, ind.pop][age_range] %>% as.vector() %>% unlist
FOI_sero_cumsum = sapply(gamma, function(x) (age_range)*x)
seropos = 1-exp(-FOI_sero_cumsum)
sus_v = pop_v * (cov_v + (1-cov_v) * seropos)
p = colSums(sus_v)/sum(pop_v)
p[p > 1 - 1e-16] = 1 - 1e-16
p[p < 1e-16] = 1e-16
p_m[study_row,] = p
}
p_m_sum = apply(p_m, 1, quantile95cri)
sero_data_fit = cbind(data_subset, model_type, study, data_type, sel_sero_data[,1:8], data.frame(t(p_m_sum)))
sero_data_fit_l = c(sero_data_fit_l, list(sero_data_fit))
#WAIC:
LL_samples = sapply(1:n_samples, function(x) dbinom(sel_sero_data$POSITIVE, sel_sero_data$SAMPLE_SIZE, p_m[,x], log = T))
lppd <- sapply(1:nrow(sel_sero_data), function(i) logSumExp(LL_samples[i,]) - log(n_samples)) %>% sum
pWAIC <- sapply(1:nrow(sel_sero_data) , function(i) var(LL_samples[i,])) %>% sum
WAIC = -2*(lppd - pWAIC)
WAIC_l = c(WAIC_l, WAIC)
} else if(data_type == "case"){
sel_case_data = filter(case.noti.df, study_id == study)
gamma = par_sel[,1];
rho = inverse_logit(par_sel[,2]);
VE = par_sel[,3]
FOI_case_id_row = max(sel_case_data$year) - sel_case_data$year + sel_case_data$age + 1
FOI_case_int_v = sapply(gamma, function(x) (FOI_case_id_row - 1) * x) %>% t
pop_m = matrix(sel_case_data$pop, nrow = n_samples, ncol = nrow(sel_case_data))
cov_m = matrix(sel_case_data$cov, nrow = n_samples, ncol = nrow(sel_case_data))
exp_cases = exp(-FOI_case_int_v) * (1 - exp(-gamma)) * rho * pop_m * (1 - cov_m*VE)
exp_case_by_age_group = aggregate(t(exp_cases), by = list(sel_case_data$age_group_ID), sum)[,-1]
exp_case_by_age_group[exp_case_by_age_group < 1e-3] = 1e-3
exp_case_by_age_group_sum = apply(exp_case_by_age_group, 1, quantile95cri)
case_by_study_agegroup_i = aggregate(sel_case_data$case, by = list(sel_case_data$age_group_ID), unique)$x
case_data_fit = data.frame(data_subset, model_type, study, data_type,
age_l = aggregate(sel_case_data$age, by = list(sel_case_data$age_group_ID), min)$x,
age_u = aggregate(sel_case_data$age, by = list(sel_case_data$age_group_ID), max)$x,
t(exp_case_by_age_group_sum), case = case_by_study_agegroup_i)
case_data_fit_l = c(case_data_fit_l, list(case_data_fit))
#WAIC:
LL_samples = sapply(1:n_samples, function(x) dpois(case_by_study_agegroup_i, exp_case_by_age_group[,x], log = T))
lppd_v <- sapply(1:nrow(exp_case_by_age_group), function(i) logSumExp(LL_samples[i,]) - log(n_samples))
pWAIC_v <- sapply(1:nrow(exp_case_by_age_group) , function(i) var(LL_samples[i,]))
WAIC_v = -2*(lppd_v - pWAIC_v)
WAIC_v_l = c(WAIC_v_l, WAIC_v)
WAIC_l = c(WAIC_l, sum(WAIC_v))
}
}
WAIC_v_l
sero_data_fit_l
nrow(sero_data_fit)
nrow(case_data_fit)
case_data_fit_l
sero_data_fit = Reduce(rbind, sero_data_fit_l)
case_data_fit = Reduce(rbind, case_data_fit_l)
nrow(sero_data_fit)
nrow(case_data_fit)
par_sum_l = c()
par_dist_l = c()
sero_data_fit_l = c()
case_data_fit_l = c()
WAIC_v_l = c()
WAIC_l = c()
#Read output:
for(which.scenario in 1:N_study){
study = all_scen$study_id[which.scenario]
data_type = all_scen$data_type[which.scenario]
print(study)
output = readRDS(paste0("../output/MCMC_output/MCMC_output_1e4_noage_", data_type, "_", study, "_init_rstan.Rdata"))
#summary parameters:
par_sum = summary(output)$summary[-which(rownames(summary(output)$summary) == "lp__"),c("2.5%", "50%", "97.5%", "Rhat")] %>% data.frame()
par_sum$Study_id = study
par_sum$data_type = data_type
par_sum_l = c(par_sum_l, list(par_sum))
#par extract
par_sel = extract(output, pars = "lp__", include = FALSE) %>% Reduce(cbind, .)
par_dist_l = c(par_dist_l, list(par_sel))
n_samples = nrow(par_sel)
#data fit and WAIC:
if(data_type == "sero"){
sel_sero_data = filter(sero_data, STUDY_ID == study)
if(study %in% c("ETH-10-2014-TSEGAYE", "NGA-8-2008-BABA")){
sel_0_cov_study = which(sel_sero_data$STUDY_ID %in% c("ETH-10-2014-TSEGAYE", "NGA-8-2008-BABA")) #no coverage for Baba and Tsegaye
sel_sero_data[sel_0_cov_study,ind.cov] = 0
}
gamma = par_sel[,1];
VE = par_sel[,2]
p_m  = matrix(nrow = nrow(sel_sero_data), ncol = nrow(par_sel))
for(study_row in 1:nrow(sel_sero_data)){
age_range = sel_sero_data$AGE_LOWER[study_row]:sel_sero_data$AGE_UPPER[study_row] + 1
cov_v = sel_sero_data[study_row, ind.cov][age_range] %>% sapply(function(x) x*VE) %>% t
pop_v = sel_sero_data[study_row, ind.pop][age_range] %>% as.vector() %>% unlist
FOI_sero_cumsum = sapply(gamma, function(x) (age_range)*x)
seropos = 1-exp(-FOI_sero_cumsum)
sus_v = pop_v * (cov_v + (1-cov_v) * seropos)
p = colSums(sus_v)/sum(pop_v)
p[p > 1 - 1e-16] = 1 - 1e-16
p[p < 1e-16] = 1e-16
p_m[study_row,] = p
}
p_m_sum = apply(p_m, 1, quantile95cri)
sero_data_fit = cbind(data_subset, model_type, study, data_type, sel_sero_data[,1:8], data.frame(t(p_m_sum)))
sero_data_fit_l = c(sero_data_fit_l, list(sero_data_fit))
#WAIC:
LL_samples = sapply(1:n_samples, function(x) dbinom(sel_sero_data$POSITIVE, sel_sero_data$SAMPLE_SIZE, p_m[,x], log = T))
lppd_v <- sapply(1:nrow(exp_case_by_age_group), function(i) logSumExp(LL_samples[i,]) - log(n_samples))
pWAIC_v <- sapply(1:nrow(exp_case_by_age_group) , function(i) var(LL_samples[i,]))
WAIC_v = -2*(lppd_v - pWAIC_v)
WAIC_v_l = c(WAIC_v_l, WAIC_v)
WAIC_l = c(WAIC_l, sum(WAIC_v))
} else if(data_type == "case"){
sel_case_data = filter(case.noti.df, study_id == study)
gamma = par_sel[,1];
rho = inverse_logit(par_sel[,2]);
VE = par_sel[,3]
FOI_case_id_row = max(sel_case_data$year) - sel_case_data$year + sel_case_data$age + 1
FOI_case_int_v = sapply(gamma, function(x) (FOI_case_id_row - 1) * x) %>% t
pop_m = matrix(sel_case_data$pop, nrow = n_samples, ncol = nrow(sel_case_data))
cov_m = matrix(sel_case_data$cov, nrow = n_samples, ncol = nrow(sel_case_data))
exp_cases = exp(-FOI_case_int_v) * (1 - exp(-gamma)) * rho * pop_m * (1 - cov_m*VE)
exp_case_by_age_group = aggregate(t(exp_cases), by = list(sel_case_data$age_group_ID), sum)[,-1]
exp_case_by_age_group[exp_case_by_age_group < 1e-3] = 1e-3
exp_case_by_age_group_sum = apply(exp_case_by_age_group, 1, quantile95cri)
case_by_study_agegroup_i = aggregate(sel_case_data$case, by = list(sel_case_data$age_group_ID), unique)$x
case_data_fit = data.frame(data_subset, model_type, study, data_type,
age_l = aggregate(sel_case_data$age, by = list(sel_case_data$age_group_ID), min)$x,
age_u = aggregate(sel_case_data$age, by = list(sel_case_data$age_group_ID), max)$x,
t(exp_case_by_age_group_sum), case = case_by_study_agegroup_i)
case_data_fit_l = c(case_data_fit_l, list(case_data_fit))
#WAIC:
LL_samples = sapply(1:n_samples, function(x) dpois(case_by_study_agegroup_i, exp_case_by_age_group[,x], log = T))
lppd_v <- sapply(1:nrow(exp_case_by_age_group), function(i) logSumExp(LL_samples[i,]) - log(n_samples))
pWAIC_v <- sapply(1:nrow(exp_case_by_age_group) , function(i) var(LL_samples[i,]))
WAIC_v = -2*(lppd_v - pWAIC_v)
WAIC_v_l = c(WAIC_v_l, WAIC_v)
WAIC_l = c(WAIC_l, sum(WAIC_v))
}
}
LL_samples
sero_data_fit
par_sum_l = c()
par_dist_l = c()
sero_data_fit_l = c()
case_data_fit_l = c()
WAIC_v_l = c()
WAIC_l = c()
#Read output:
for(which.scenario in 1:N_study){
study = all_scen$study_id[which.scenario]
data_type = all_scen$data_type[which.scenario]
print(study)
output = readRDS(paste0("../output/MCMC_output/MCMC_output_1e4_noage_", data_type, "_", study, "_init_rstan.Rdata"))
#summary parameters:
par_sum = summary(output)$summary[-which(rownames(summary(output)$summary) == "lp__"),c("2.5%", "50%", "97.5%", "Rhat")] %>% data.frame()
par_sum$Study_id = study
par_sum$data_type = data_type
par_sum_l = c(par_sum_l, list(par_sum))
#par extract
par_sel = extract(output, pars = "lp__", include = FALSE) %>% Reduce(cbind, .)
par_dist_l = c(par_dist_l, list(par_sel))
n_samples = nrow(par_sel)
#data fit and WAIC:
if(data_type == "sero"){
sel_sero_data = filter(sero_data, STUDY_ID == study)
if(study %in% c("ETH-10-2014-TSEGAYE", "NGA-8-2008-BABA")){
sel_0_cov_study = which(sel_sero_data$STUDY_ID %in% c("ETH-10-2014-TSEGAYE", "NGA-8-2008-BABA")) #no coverage for Baba and Tsegaye
sel_sero_data[sel_0_cov_study,ind.cov] = 0
}
gamma = par_sel[,1];
VE = par_sel[,2]
p_m  = matrix(nrow = nrow(sel_sero_data), ncol = nrow(par_sel))
for(study_row in 1:nrow(sel_sero_data)){
age_range = sel_sero_data$AGE_LOWER[study_row]:sel_sero_data$AGE_UPPER[study_row] + 1
cov_v = sel_sero_data[study_row, ind.cov][age_range] %>% sapply(function(x) x*VE) %>% t
pop_v = sel_sero_data[study_row, ind.pop][age_range] %>% as.vector() %>% unlist
FOI_sero_cumsum = sapply(gamma, function(x) (age_range)*x)
seropos = 1-exp(-FOI_sero_cumsum)
sus_v = pop_v * (cov_v + (1-cov_v) * seropos)
p = colSums(sus_v)/sum(pop_v)
p[p > 1 - 1e-16] = 1 - 1e-16
p[p < 1e-16] = 1e-16
p_m[study_row,] = p
}
p_m_sum = apply(p_m, 1, quantile95cri)
sero_data_fit = cbind(data_subset, model_type, study, data_type, sel_sero_data[,1:8], data.frame(t(p_m_sum)))
sero_data_fit_l = c(sero_data_fit_l, list(sero_data_fit))
#WAIC:
LL_samples = sapply(1:n_samples, function(x) dbinom(sel_sero_data$POSITIVE, sel_sero_data$SAMPLE_SIZE, p_m[,x], log = T))
lppd_v <- sapply(1:nrow(sero_data_fit), function(i) logSumExp(LL_samples[i,]) - log(n_samples))
pWAIC_v <- sapply(1:nrow(sero_data_fit) , function(i) var(LL_samples[i,]))
WAIC_v = -2*(lppd_v - pWAIC_v)
WAIC_v_l = c(WAIC_v_l, WAIC_v)
WAIC_l = c(WAIC_l, sum(WAIC_v))
} else if(data_type == "case"){
sel_case_data = filter(case.noti.df, study_id == study)
gamma = par_sel[,1];
rho = inverse_logit(par_sel[,2]);
VE = par_sel[,3]
FOI_case_id_row = max(sel_case_data$year) - sel_case_data$year + sel_case_data$age + 1
FOI_case_int_v = sapply(gamma, function(x) (FOI_case_id_row - 1) * x) %>% t
pop_m = matrix(sel_case_data$pop, nrow = n_samples, ncol = nrow(sel_case_data))
cov_m = matrix(sel_case_data$cov, nrow = n_samples, ncol = nrow(sel_case_data))
exp_cases = exp(-FOI_case_int_v) * (1 - exp(-gamma)) * rho * pop_m * (1 - cov_m*VE)
exp_case_by_age_group = aggregate(t(exp_cases), by = list(sel_case_data$age_group_ID), sum)[,-1]
exp_case_by_age_group[exp_case_by_age_group < 1e-3] = 1e-3
exp_case_by_age_group_sum = apply(exp_case_by_age_group, 1, quantile95cri)
case_by_study_agegroup_i = aggregate(sel_case_data$case, by = list(sel_case_data$age_group_ID), unique)$x
case_data_fit = data.frame(data_subset, model_type, study, data_type,
age_l = aggregate(sel_case_data$age, by = list(sel_case_data$age_group_ID), min)$x,
age_u = aggregate(sel_case_data$age, by = list(sel_case_data$age_group_ID), max)$x,
t(exp_case_by_age_group_sum), case = case_by_study_agegroup_i)
case_data_fit_l = c(case_data_fit_l, list(case_data_fit))
#WAIC:
LL_samples = sapply(1:n_samples, function(x) dpois(case_by_study_agegroup_i, exp_case_by_age_group[,x], log = T))
lppd_v <- sapply(1:nrow(exp_case_by_age_group), function(i) logSumExp(LL_samples[i,]) - log(n_samples))
pWAIC_v <- sapply(1:nrow(exp_case_by_age_group) , function(i) var(LL_samples[i,]))
WAIC_v = -2*(lppd_v - pWAIC_v)
WAIC_v_l = c(WAIC_v_l, WAIC_v)
WAIC_l = c(WAIC_l, sum(WAIC_v))
}
}
par_sum = par_sum_l %>% lapply(function(x) {
x$par = rownames(x)
return(x)
}) %>% Reduce(rbind, .)
sero_data_fit = Reduce(rbind, sero_data_fit_l)
case_data_fit = Reduce(rbind, case_data_fit_l)
all_scen$WAIC = WAIC_l
length(WAIC_v_l)
saveRDS(list(par_sum = par_sum, par_dist = par_dist_l,
sero_data_fit = sero_data_fit, case_data_fit = case_data_fit,
WAIC = all_scen, WAIC_v = WAIC_v_l),
"../output/par_sum_fit_noage.rds")
#
#Alternative models####
heir_country_model = readRDS("../output/par_sum_fit_heir.rds")
heir_globalcurve_model = readRDS("../output/par_sum_fit_heir_globalcurve.rds")
noage_model = readRDS("../output/par_sum_fit_noage.rds")
dif_WAIC_v_noage_global = noage_model$WAIC_v - heir_globalcurve_model$WAIC_v
dif_WAIC_v_noage_coun = noage_model$WAIC_v - heir_country_model$WAIC_v
dif_WAIC_v_global_coun = heir_globalcurve_model$WAIC_v - heir_country_model$WAIC_v
dif_WAIC_v_noage_global
dif_WAIC_v_noage_coun
var(dif_WAIC_v_noage_coun)
WAIC_comp2
noage_model
heir_country_model$Age_depend_sum_data
heir_country_model$sero_data_fit
case_data_fit_all_data
#datafit:
noage_model_sero_data_fit = noage_model$sero_data_fit
noage_model_sero_data_fit$STUDY_ID = noage_model_sero_data_fit$study
sero_data_fit_all = bind_rows(noage_model_sero_data_fit, heir_country_model$sero_data_fit, heir_globalcurve_model$sero_data_fit)
sero_data_fit_all_plot = sero_data_fit_all %>%
cbind(CI = sapply(c(0.025, 0.5, 0.975), function(x) qbeta(x, sero_data_fit_all$POSITIVE + 1, sero_data_fit_all$SAMPLE_SIZE  - sero_data_fit_all$POSITIVE + 1))) %>%
mutate(AGE_RANGE = paste0(formatC(AGE_LOWER, width = 2, flag = 0), "-", formatC(AGE_UPPER, width = 2, flag = 0)),
AGE_MID = (AGE_LOWER + AGE_UPPER)/2) %>%
mutate(mod_STUDY_ID = mapply(rep, source_names[1:4], rle(sero_data_fit_all$STUDY_ID)$lengths) %>% unlist)
sero_data_fit_all_plot$Model = factor(rep(three_models_name, each = nrow(noage_model_sero_data_fit)), levels = three_models_name)
sero_fit_all_plot = ggplot(sero_data_fit_all_plot, aes(x = AGE_MID, group = Model))+
geom_pointrange(aes(ymin = CI.1, ymax = CI.3, y = CI.2))+
geom_ribbon(aes(ymin = X2.5., ymax = X97.5., fill = Model), alpha = 0.7)+
geom_line(aes(y = X50.), color = "black")+
scale_color_manual(values = three_subset_color[c(1,3,2)])+
scale_fill_manual(values = three_subset_color[c(1,3,2)])+
labs(x = "Age", y = "Positive proportion", color = "Data subset", fill = "Data subset")+
facet_wrap(.~mod_STUDY_ID, scale = "free_y")+
theme_bw()+
theme(text = element_text(size = 18),
axis.text.x = element_text(size = 12))
sero_fit_all_plot
noage_model_case_data_fit = noage_model$case_data_fit
colnames(noage_model_case_data_fit) = c(colnames(noage_model_case_data_fit)[1:2], "study_id", "data_type", "age_min", "age_max", colnames(noage_model_case_data_fit)[7:12])
case_data_fit_all = bind_rows(noage_model_case_data_fit, heir_country_model$case_data_fit, heir_globalcurve_model$case_data_fit)
case_data_fit_all_data = case_data_fit_all %>%
mutate(AGE_RANGE = paste0(formatC(age_min, width = 2, flag = 0), "-", formatC(age_max, width = 2, flag = 0)),
AGE_MID = (age_min + age_max)/2) %>%
# mutate(data_subset = case_when(
#   data_subset == "AF" ~ Subset_order[1],
#   data_subset == "SA" ~ Subset_order[2],
#   data_subset == "SA_AF" ~ Subset_order[3]
# )) %>%
mutate(mod_STUDY_ID = mapply(rep, c(source_names[5:30]), rle(case_data_fit_all$study_id)$lengths) %>% unlist)
#case_data_fit_data$data_subset = factor(case_data_fit_data$data_subset, levels = Subset_order)
case_data_fit_all_data$mod_STUDY_ID = factor(case_data_fit_all_data$mod_STUDY_ID, levels = source_names[5:30])
case_data_fit_all_data$Model = factor(rep(three_models_name, each = nrow(noage_model_case_data_fit)), levels = three_models_name)
case_fit_all_plot = ggplot(case_data_fit_all_data, aes(x = AGE_MID))+
geom_ribbon(aes(ymin = X2.5., ymax = X97.5., fill = Model), alpha = 0.7)+
geom_line(aes(y = X50., group = Model), color = "black")+
geom_point(aes(y = case))+
scale_color_manual(values = three_subset_color[c(1,3,2)])+
scale_fill_manual(values = three_subset_color[c(1,3,2)])+
#scale_y_log10()+
labs(x = "Age", y = "Positive proportion", color = "Data subset", fill = "Data subset")+
facet_wrap(.~mod_STUDY_ID, scale = "free_y", ncol = 5)+
theme_bw()+
theme(text = element_text(size = 18),
axis.text.x = element_text(size = 12))
case_fit_all_plot
case_data_fit_all_data
noage_model_sero_data_fit
noage_model_case_data_fit$study_id
noage_model_sero_data_fit$STUDY_ID
noage_model_case_data_fit$study_id
rle(c(noage_model_sero_data_fit$STUDY_ID, noage_model_case_data_fit$study_id))
rle(c(noage_model_sero_data_fit$STUDY_ID, noage_model_case_data_fit$study_id))$lengths
mapply(1:N_study, FUN = rep, each = rle(c(noage_model_sero_data_fit$STUDY_ID, noage_model_case_data_fit$study_id))$lengths)
mapply(1:N_study, FUN = rep, each = rle(c(noage_model_sero_data_fit$STUDY_ID, noage_model_case_data_fit$study_id))$lengths) %>% unlist
nrow_all_data = mapply(1:N_study, FUN = rep, each = rle(c(noage_model_sero_data_fit$STUDY_ID, noage_model_case_data_fit$study_id))$lengths) %>% unlist
nrow_all_data
study = 1
best_model_id_study = best_model_id[study]
best_model_id_study
best_model_id_study
WAIC_comp2
nrow_all_data
dif_WAIC_v_noage_global[which(nrow_all_data == study)]
-dif_WAIC_v_global_coun[which(nrow_all_data == study)]
nrow_data_study_id = which(nrow_all_data == study)
nrow_data_study_id
dif_WAIC_v_noage_global[nrow_data_study_id]
-dif_WAIC_v_global_coun[nrow_data_study_id]
length(nrow_data_study_id)*var(dif_WAIC_v_noage_global[nrow_data_study_id])
sqrt(length(nrow_data_study_id)*var(dif_WAIC_v_noage_global[nrow_data_study_id]))
c(-1.96, 1.96)*sqrt(length(nrow_data_study_id)*var(dif_WAIC_v_noage_global[nrow_data_study_id]))
CI95_diff_1 = c(-1.96, 1.96)*sqrt(length(nrow_data_study_id)*var(dif_WAIC_v_noage_global[nrow_data_study_id]))
CI95_diff_1
dif_WAIC_v_noage_global
CI95_diff_1
WAIC_comp2[study,c(3:5)]
CI95_diff_1 = WAIC_comp2[study,1] + c(-1.96, 1.96)*sqrt(length(nrow_data_study_id)*var(dif_WAIC_v_noage_global[nrow_data_study_id]))
WAIC_comp2[study,1]
CI95_diff_1 = WAIC_comp2[study,3] + c(-1.96, 1.96)*sqrt(length(nrow_data_study_id)*var(dif_WAIC_v_noage_global[nrow_data_study_id]))
CI95_diff_1
WAIC_comp2
CI95_diff_2 = WAIC_comp2[study,3] + c(-1.96, 1.96)*sqrt(length(nrow_data_study_id)*var(-dif_WAIC_v_global_coun[nrow_data_study_id]))
CI95_diff_2 = WAIC_comp2[study,2] + c(-1.96, 1.96)*sqrt(length(nrow_data_study_id)*var(-dif_WAIC_v_global_coun[nrow_data_study_id]))
WAIC_comp2[study,2]
WAIC_comp2[study,4]
CI95_diff_2 = WAIC_comp2[study,4] + c(-1.96, 1.96)*sqrt(length(nrow_data_study_id)*var(-dif_WAIC_v_global_coun[nrow_data_study_id]))
CI95_diff_2
CI95_diff_1
round(CI95_diff_1, 1)
WAIC_comp2
paste0(round(WAIC_comp2[study,3], 1), round(CI95_diff_1, 1))
c(paste0(round(WAIC_comp2[study,3], 1), " (", paste0(round(CI95_diff_1, 1), collapse = " - "), ")"))
paste0(round(WAIC_comp2[study,4], 1), " (", paste0(round(CI95_diff_2, 1), collapse = " - "), ")")
WAIC_comp2[,c(3:5)] = c(paste0(round(WAIC_comp2[study,3], 1), " (", paste0(round(CI95_diff_1, 1), collapse = " - "), ")"),
paste0(round(WAIC_comp2[study,4], 1), " (", paste0(round(CI95_diff_2, 1), collapse = " - "), ")"),
0)
WAIC_comp2
WAIC_comp2 = noage_model$WAIC; colnames(WAIC_comp2) = c(colnames(WAIC_comp2)[1:2], "No_age")
WAIC_comp2$Coun_spec = heir_country_model$WAIC_data$x
WAIC_comp2$Global = heir_globalcurve_model$WAIC_data$x
WAIC_comp2[,c(3:5)] = WAIC_comp2[,c(3:5)] %>% apply(1, function(x) x - min(x)) %>% t %>% round(1)
best_model_id = apply(WAIC_comp2[c(3:5)], 1, function(x) which(x == 0))
WAIC_comp2[study,c(3:5)] = c(paste0(round(WAIC_comp2[study,3], 1), " (", paste0(round(CI95_diff_1, 1), collapse = " - "), ")"),
paste0(round(WAIC_comp2[study,4], 1), " (", paste0(round(CI95_diff_2, 1), collapse = " - "), ")"),
0)
WAIC_comp2
nrow_all_data
study = 4
best_model_id_study = best_model_id[study]
best_model_id_study
best_model_id_study
nrow_data_study_id = which(nrow_all_data == study)
nrow_data_study_id
CI95_diff_1 = WAIC_comp2[study,4] + c(-1.96, 1.96)*sqrt(length(nrow_data_study_id)*var(dif_WAIC_v_noage_coun[nrow_data_study_id]))
nrow_data_study_id
WAIC_comp2
dif_WAIC_v_noage_coun
dif_WAIC_v_noage_coun[nrow_data_study_id]
length(nrow_data_study_id)
c(-1.96, 1.96)*sqrt(length(nrow_data_study_id)*var(dif_WAIC_v_noage_coun[nrow_data_study_id]))
WAIC_comp2[study,4]
WAIC_comp2[study,3]
CI95_diff_1 = as.numeric(WAIC_comp2[study,3]) + c(-1.96, 1.96)*sqrt(length(nrow_data_study_id)*var(dif_WAIC_v_noage_coun[nrow_data_study_id]))
CI95_diff_1
WAIC_comp2
as.numeric(WAIC_comp2[study,4])
CI95_diff_2 = as.numeric(WAIC_comp2[study,5]) + c(-1.96, 1.96)*sqrt(length(nrow_data_study_id)*var(dif_WAIC_v_global_coun[nrow_data_study_id]))
CI95_diff_2
c(paste0(round(WAIC_comp2[study,3], 1), " (", paste0(round(CI95_diff_1, 1), collapse = " - "), ")"),0,
paste0(round(WAIC_comp2[study,5], 1), " (", paste0(round(CI95_diff_2, 1), collapse = " - "), ")"))
nrow_all_data = mapply(1:N_study, FUN = rep, each = rle(c(noage_model_sero_data_fit$STUDY_ID, noage_model_case_data_fit$study_id))$lengths) %>% unlist
WAIC_comp2 = noage_model$WAIC; colnames(WAIC_comp2) = c(colnames(WAIC_comp2)[1:2], "No_age")
WAIC_comp2$Coun_spec = heir_country_model$WAIC_data$x
WAIC_comp2$Global = heir_globalcurve_model$WAIC_data$x
WAIC_comp2[,c(3:5)] = WAIC_comp2[,c(3:5)] %>% apply(1, function(x) x - min(x)) %>% t %>% round(1)
best_model_id = apply(WAIC_comp2[c(3:5)], 1, function(x) which(x == 0))
dif_WAIC_v_noage_global = noage_model$WAIC_v - heir_globalcurve_model$WAIC_v
dif_WAIC_v_noage_coun = noage_model$WAIC_v - heir_country_model$WAIC_v
dif_WAIC_v_global_coun = heir_globalcurve_model$WAIC_v - heir_country_model$WAIC_v
nrow_all_data = mapply(1:N_study, FUN = rep, each = rle(c(noage_model_sero_data_fit$STUDY_ID, noage_model_case_data_fit$study_id))$lengths) %>% unlist
for(study in 1:N_study){
best_model_id_study = best_model_id[study]
if(best_model_id_study == 3){
nrow_data_study_id = which(nrow_all_data == study)
CI95_diff_1 = as.numeric(WAIC_comp2[study,3]) + c(-1.96, 1.96)*sqrt(length(nrow_data_study_id)*var(dif_WAIC_v_noage_global[nrow_data_study_id]))
CI95_diff_2 = as.numeric(WAIC_comp2[study,4]) + c(-1.96, 1.96)*sqrt(length(nrow_data_study_id)*var(-dif_WAIC_v_global_coun[nrow_data_study_id]))
WAIC_comp2[study,c(3:5)] = c(paste0(round(as.numeric(WAIC_comp2[study,3]), 1), " (", paste0(round(CI95_diff_1, 1), collapse = " - "), ")"),
paste0(round(as.numeric(WAIC_comp2[study,4]), 1), " (", paste0(round(CI95_diff_2, 1), collapse = " - "), ")"),
0)
}
if(best_model_id_study == 2){
nrow_data_study_id = which(nrow_all_data == study)
CI95_diff_1 = as.numeric(WAIC_comp2[study,3]) + c(-1.96, 1.96)*sqrt(length(nrow_data_study_id)*var(dif_WAIC_v_noage_coun[nrow_data_study_id]))
CI95_diff_2 = as.numeric(WAIC_comp2[study,5]) + c(-1.96, 1.96)*sqrt(length(nrow_data_study_id)*var(dif_WAIC_v_global_coun[nrow_data_study_id]))
WAIC_comp2[study,c(3:5)] = c(paste0(round(as.numeric(WAIC_comp2[study,3]), 1), " (", paste0(round(CI95_diff_1, 1), collapse = " - "), ")"),0,
paste0(round(as.numeric(WAIC_comp2[study,5]), 1), " (", paste0(round(CI95_diff_2, 1), collapse = " - "), ")"))
}
}
WAIC_comp2
dif_WAIC_v_noage_global
dif_WAIC_v_noage_global
#all data:
sum(dif_WAIC_v_noage_global)
sum(dif_WAIC_v_global_coun)
#all data:
sum(dif_WAIC_v_noage_coun)
sum(dif_WAIC_v_global_coun)
sum(dif_WAIC_v_global_coun)
dif_WAIC_v_noage_coun
#all data:
sum(dif_WAIC_v_noage_coun) + c(-1.96, 1.96)*sqrt(length(dif_WAIC_v_noage_coun)*var(dif_WAIC_v_noage_coun))
var(dif_WAIC_v_noage_coun)
sum(dif_WAIC_v_global_coun) + c(-1.96, 1.96)*sqrt(length(dif_WAIC_v_noage_coun)*var(dif_WAIC_v_global_coun))
dif_WAIC_v_noage_coun
noage_model$WAIC_v
sqrt(length(noage_model$WAIC_v)*var(noage_model$WAIC_v))
